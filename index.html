<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Bookmarklets - lasercar/marklets</title>

  <style>

    body {
      font-family: sans-serif;
      text-align: center;
    }

    .marklets {
      text-align: right;
      /* TODO: center div with contents right-aligned and flexible width */
    }

    ul {
      list-style: none;
    }

  </style>
</head>
<body>

  <div class="header"><h1>Bookmarklets</h1>
    <h2><a href="https://github.com/lasercar/marklets">lasercar/marklets</a></h2>
  </div>

  <hr>

  <div class="marklets">
    <ul id="marklets"></ul>
  </div>

  <hr>

  <div class="footer">
    <p>footer</p>
  </div>

<!-- script -->
  <script>

    var elements = {
      marklets: document.querySelector("#marklets")
    };

    var templates = {
      Seperator: function() {
        //TODO: extend HTMLElement prototypes instead of calling createElement?
        var seperatorElm = document.createElement("span");
        seperatorElm.innerHTML = " - ";
        return seperatorElm;
      },
      MarkletMeta: function(info) {
        var metaElm = document.createElement("span");
        metaElm.innerHTML = info;
        return metaElm;
      },
      Marklet: function Marklet(name, url) {
        var markletElm = document.createElement("a");
        markletElm.innerHTML = name;
        markletElm.href = url;
        return markletElm;
      },
      MarkletContainer: function Container(data) {
        var containerElm = document.createElement("li");
        var markletElm = new templates.Marklet(data.name, data.url);
        var seperatorElm = new templates.Seperator();
        if (data.info) {
          var metaElm = new templates.MarkletMeta(data.info);
          containerElm.appendChild(metaElm);
          containerElm.appendChild(seperatorElm)
        }
        containerElm.appendChild(markletElm);
        return containerElm;
      }
    };

    function renderMarklet(data) { //data = {name,url,?info}
      var container = new templates.MarkletContainer(data);
      elements.marklets.appendChild(container);
    }

    function renderMarklet(dataset) { //dataset = [{name,url,?info},...]
      dataset.forEach(function(data) {
        renderMarklet(data);
      });
    }

    function parseMarklet() {
      //parse file into marklet url
    }

    function markletCallback(event, data) {
      //parse, render
      console.log("event.target.response: " + event.target.response);
      console.log("data: " + JSON.stringify(data));
    }

    function fetchMarklet(data) {
      var path = "marklets/" + data.path;
      var xhr = new XMLHttpRequest();
      xhr.addEventListener("load", function(event) {
        markletCallback(event, data);
      });
      xhr.open("GET", path);
      xhr.send();
    }

    function fetchMarklets(index) {
      //async, split for each marklet
      for (i in index) {
        fetchMarklet(index[i]);
      }
    }

    function indexCallback(event) {
      var index = JSON.parse(event.target.response);
      fetchMarklets(index);
    }

    function fetchIndex() {
      //async
      var xhr = new XMLHttpRequest();
      xhr.addEventListener("load", indexCallback);
      xhr.open("GET", "marklets.json");
      xhr.send();
    }

    function init() {
      fetchIndex();
      //async, run backwards per-file with callbacks
      //use promises in the future?
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
