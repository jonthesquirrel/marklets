<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Bookmarklets - lasercar/marklets</title>

  <style>

    body {
      font-family: sans-serif;
      text-align: center;
    }

    .marklets {
      /* TODO: center div with contents right-aligned and flexible width */
    }

    ul {
      text-align: left;
      list-style: none;
    }

  </style>
</head>
<body>

  <div class="header"><h1>Bookmarklets</h1>
    <h2><a href="https://github.com/lasercar/marklets">lasercar/marklets</a></h2>
    <p>
      Marklets are JavaScript. Drag them to your bookmarks bar to install them, then click them on any website to run the script.
      Marklets are useful and powerful, because they run with the same permissions (client-side) as the website you run them on. It is sensible to be cautious, so feel free to look at the source code of the marklets if you wish.
    </p>
  </div>

  <hr>

  <div class="marklets">
    <b>Marklets</b>
    <ul id="marklets"></ul>
  </div>

  <hr>

  <div class="custom">
    <i>coming soon: convert your own scripts to bookmarklets</i>
    <!-- TODO -->
  </div>

  <hr>

  <div class="about">
    <p>
      <b>Developers</b><br>
      To work properly, your javascript must be encased in an anonymous function (or void(0); at end). It must use semicolons at ends of lines, and not use single-line comments.
    </p>
    <code>
      (function() {<br>
        your script here<br>
      })();<br>
    </code>
    <p>This website then encodeds the script to be URL-safe, and adds a <code>javascript:</code> prefix. This is a bookmarklet.</p>
  </div>

  <hr>

  <div class="footer">
    <i>(c) Copyright 2015 Lasercar7 (@lasercar). You may use everything on this website however you wish, according to the MIT License.</i>
  </div>

<!-- script -->
  <script>

    var elements = {
      marklets: document.querySelector("#marklets")
    };

    var templates = {
      Seperator: function() {
        //FUTURE extend HTMLElement prototypes instead of calling createElement?
        var seperatorElm = document.createElement("span");
        seperatorElm.innerHTML = " - ";
        return seperatorElm;
      },
      MarkletMeta: function(info) {
        var metaElm = document.createElement("span");
        metaElm.innerHTML = info;
        return metaElm;
      },
      Marklet: function Marklet(name, url) {
        var markletElm = document.createElement("a");
        markletElm.innerHTML = name;
        markletElm.href = url;
        return markletElm;
      },
      MarkletContainer: function Container(data) {
        var containerElm = document.createElement("li");
        //TODO
        //<a href="marklets/ + data.path">(source)</a>
        //seperator
        var markletElm = new templates.Marklet(data.name, data.url);
        var seperatorElm = new templates.Seperator();
        containerElm.appendChild(markletElm);
        if (data.info) {
          var metaElm = new templates.MarkletMeta(data.info);
          containerElm.appendChild(seperatorElm)
          containerElm.appendChild(metaElm);
        }
        return containerElm;
      }
    };

    function renderMarklet(data) { //data = {name,url,?info}
      var container = new templates.MarkletContainer(data);
      elements.marklets.appendChild(container);
    }

    function parseMarklet(script) {
      var url = encodeURIComponent(script);
      url = "javascript:" + url;
      return url;
    }

    function markletCallback(event, data) {
      data.script = event.target.response;
      data.url = parseMarklet(data.script);
      renderMarklet(data);
    }

    function fetchMarklet(data) {
      //TODO write data.file in marklets index, then convert into data.path here by adding "marklets/"
      var path = "marklets/" + data.path;
      var xhr = new XMLHttpRequest();
      xhr.addEventListener("load", function(event) {
        markletCallback(event, data);
      });
      xhr.open("GET", path);
      xhr.send();
    }

    function fetchMarklets(index) {
      //async, split for each marklet
      for (i in index) {
        fetchMarklet(index[i]);
      }
    }

    function indexCallback(event) {
      var index = JSON.parse(event.target.response);
      fetchMarklets(index);
    }

    function fetchIndex() {
      //async
      var xhr = new XMLHttpRequest();
      xhr.addEventListener("load", indexCallback);
      xhr.open("GET", "marklets.json");
      xhr.send();
    }

    function init() {
      fetchIndex();
      //async, run backwards per-file with callbacks
      //FUTURE use promises?
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
